name: Auto Transcribe & Commit Subtitles

on:
  push:
    paths:
      - "examples/**"

permissions:
  contents: write

jobs:
  transcribe-and-commit:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: src

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Gather changed example files
        id: gather
        run: |
          CHANGED=$(git --no-pager diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '^examples/' || true)
          # expose raw changed files (may be empty)
          echo "CHANGED_RAW<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Determine files to process
        id: files
        run: |
          CHANGED="${{ steps.gather.outputs.CHANGED_RAW }}"
          if [ -z "$CHANGED" ]; then
            echo "No changed files in diff. Scanning examples/ for media files..."
            FILES=$(find examples -maxdepth 2 -type f \( -iname "*.mp4" -o -iname "*.mkv" -o -iname "*.wav" -o -iname "*.mp3" -o -iname "*.mov" \) -print || true)
          else
            FILES="$CHANGED"
          fi
          echo "FILES_LIST<<EOF" >> $GITHUB_OUTPUT
          printf "%s\n" "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Transcribe files (loop)
        env:
          MODEL: small
        run: |
          FILES="${{ steps.files.outputs.FILES_LIST }}"
          if [ -z "$FILES" ]; then
            echo "No files to process."
            exit 0
          fi
          echo "Files to process:"
          printf "%s\n" "$FILES"
          echo "$FILES" | while IFS= read -r f; do
            [ -z "$f" ] && continue
            if [ ! -f "$f" ]; then
              echo "Skipping non-file: $f"
              continue
            fi
            echo "Transcribing: $f"
            # pass compute-type float32 for CPU runners
            if python -m autosub.transcribe_accurate --input "$f" --model "${MODEL}" --device cpu --compute-type float32; then
              echo "OK: $f"
            else
              echo "FAILED: $f"
            fi
          done

      - name: Show workspace & logs
        run: |
          echo "=== Workspace files ==="
          find . -maxdepth 6 -type f | sed -e 's/^/FILE: /'
          echo "=== Subtitle files ==="
          find . -type f \( -iname "*.srt" -o -iname "*.vtt" \) -print || echo "No subtitle files found"
          if [ -f transcribe.log ]; then
            echo "==== transcribe.log (head) ===="
            sed -n '1,200p' transcribe.log || true
          fi

      - name: Upload debug artifacts (log + subtitles)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: transcribe-debug
          path: |
            transcribe.log
            **/*.srt
            **/*.vtt

      - name: Commit subtitles if any
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          SUBFILES=$(find . -maxdepth 6 -type f \( -iname "*.srt" -o -iname "*.vtt" \) -print)
          if [ -z "$SUBFILES" ]; then
            echo "No subtitle files to commit."
            exit 0
          fi
          echo "$SUBFILES" | while IFS= read -r f; do git add -- "$f"; done
          echo "Staged files:"
          git status --short
          if git diff --cached --quiet; then
            echo "Nothing to commit."
            exit 0
          fi
          git commit -m "Auto-generated subtitles [skip ci]" || echo "Nothing to commit"
          git push origin HEAD:${{ github.ref_name }}
