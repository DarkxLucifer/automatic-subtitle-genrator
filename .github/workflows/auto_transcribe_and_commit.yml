# (inside jobs.transcribe-and-commit)
    env:
      PYTHONPATH: src

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Transcribe changed files (robust + debug)
        env:
          MODEL: small
        run: |
          set -euo pipefail
          CHANGED_RAW=$(git --no-pager diff --name-only ${{ github.event.before }} ${{ github.sha }} || true)
          CHANGED=$(printf "%s\n" "$CHANGED_RAW" | grep '^examples/' || true)
          if [ -z "$CHANGED" ]; then
            mapfile -t FILES < <(find examples -maxdepth 2 -type f \( -iname "*.mp4" -o -iname "*.mkv" -o -iname "*.wav" -o -iname "*.mp3" -o -iname "*.mov" \))
          else
            mapfile -t FILES < <(printf "%s\n" "$CHANGED")
          fi

          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No media files to process. Exiting."
            exit 0
          fi

          for f in "${FILES[@]}"; do
            echo "Transcribing '$f' ..."
            # run with PYTHONPATH=src present via job env; call autosub module
            if python -m autosub.transcribe_accurate --input "$f" --model "${MODEL}" --device cpu; then
              echo "OK: $f"
            else
              echo "FAILED: $f"
            fi
          done

      - name: Debug: list created subtitles & transcribe.log
        run: |
          echo "==== workspace files ===="
          find . -maxdepth 6 -type f | sed -e 's/^/FILE: /'
          echo "==== subtitle files ===="
          find . -type f \( -iname "*.srt" -o -iname "*.vtt" \) -print || echo "No .srt/.vtt files found"
          echo "==== transcribe.log (if exists) ===="
          if [ -f transcribe.log ]; then
            echo "---- transcribe.log start ----"
            sed -n '1,200p' transcribe.log || true
            echo "---- transcribe.log end ----"
          else
            echo "transcribe.log not found"
          fi

      - name: Upload debug artifacts (subtitles + log)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: transcribe-debug
          path: |
            transcribe.log
            **/*.srt
            **/*.vtt

      - name: Commit generated subtitles (robust)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          mapfile -t SUB_FILES < <(find . -maxdepth 6 -type f \( -iname "*.srt" -o -iname "*.vtt" \) -print)
          if [ ${#SUB_FILES[@]} -eq 0 ]; then
            echo "No subtitle files found to commit."
            exit 0
          fi
          git add -- "${SUB_FILES[@]}"
          git commit -m "Auto-generated subtitles [skip ci]" || echo "Nothing to commit"
          git push origin HEAD:${{ github.ref_name }}
